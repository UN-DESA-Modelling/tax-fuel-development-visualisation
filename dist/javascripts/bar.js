var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

define(['d3', 'data', 'graph'], function(d3, data, graph) {
  var bar, draw, factorise, pick_y, wrap;
  draw = function(opts) {
    var action, bar, container, height, highest, id, m, param, sources, width, x, xAxis, x_vars, x_vars_label, y, yAxis;
    id = opts.id;
    action = opts.action;
    x_vars = opts.x_vars;
    param = opts.param;
    width = $("#" + id + "-graph").width() - 50;
    height = _g.base_graph.height() - 20;
    sources = data.pluck(_g.queries[param], param).filter(function(s) {
      return !data.ignored_asset(s);
    });
    x_vars = x_vars.filter(function(e) {
      return !data.ignored_asset(e);
    });
    x_vars_label = x_vars.map(function(e) {
      return _g.details[e] || e;
    });
    x = d3.scale.ordinal().domain(x_vars_label).rangeRoundBands([0, width]);
    xAxis = d3.svg.axis().scale(x).orient("bottom");
    m = d3.max(sources, function(d) {
      return d['value'];
    });
    highest = x_vars.length === 1 ? _g.max_diff / 100 : d3.max(sources, function(d) {
      return Math.abs(d['value']);
    });
    y = d3.scale.linear().domain([(-1) * highest, highest]).range([height, 0]);
    yAxis = d3.svg.axis().scale(y).orient("left").tickFormat(function(v) {
      return graph.tick_format(v, m);
    });
    if (action === 'create') {
      graph.clear(id);
      container = graph.draw(id);
    }
    if (action === 'update') {
      d3.selectAll("#" + id + " .year-watermark").remove();
      d3.selectAll("#" + id + " .axis").remove();
      d3.selectAll("#" + id + " .bar-group").remove();
      container = d3.select("g#" + id);
    }
    container.append('g').attr({
      "class": 'x axis',
      transform: "translate(0, " + (height / 2) + ")"
    }).call(xAxis);
    container.selectAll(".tick text").call(wrap, x.rangeBand());
    container.append('g').attr({
      "class": 'y axis'
    }).call(yAxis);
    container.append('text').attr({
      "class": 'axis',
      x: -(height / 2),
      y: -50,
      transform: 'rotate(-90)',
      dy: '1em',
      'text-anchor': 'middle'
    }).text(function(d) {
      return "change in indicator over base %";
    });
    container.append('text').attr({
      "class": 'axis',
      x: width / 2,
      y: height,
      dy: '1em',
      'text-anchor': 'middle'
    }).text(function(d) {
      return _g.subtitles[param];
    });
    bar = container.selectAll('.bar-group').data(sources).enter().append('g').attr({
      "class": 'bar-group'
    });
    bar.append('rect').attr({
      id: function(d) {
        return d[param];
      },
      "class": 'bar',
      width: x_vars.length === 1 ? width * 0.5 : (width / x_vars.length) - 5,
      height: function(d) {
        return Math.abs(factorise(d['value'], highest, height / 2));
      },
      x: function(d) {
        if ((param != null) && d[param]) {
          return x(_g.details[d[param]]) + 5;
        } else {
          return width * 0.25;
        }
      },
      y: function(d) {
        return pick_y(d, highest, height / 2);
      },
      fill: function(d) {
        var ref;
        if (ref = d[param], indexOf.call(_g.current_assets, ref) >= 0) {
          return _g.blue;
        } else {
          return _g.grey;
        }
      },
      "fill-opacity": 0.5,
      stroke: function(d) {
        var ref;
        if (ref = d[param], indexOf.call(_g.current_assets, ref) >= 0) {
          return _g.blue;
        } else {
          return _g.grey;
        }
      },
      "stroke-opacity": 0.3
    }).on({
      'click': function(d) {
        return _g.click_focus(d, id, param);
      }
    });
    return d3.selectAll('text').moveToFront();
  };
  factorise = function(value, highest_value, height) {
    if (highest_value === 0) {
      return 0;
    }
    return value * (height / highest_value);
  };
  pick_y = function(d, highest_value, height) {
    var c;
    c = factorise(d['value'], highest_value, height);
    if (c < 0) {
      return height;
    } else {
      return height - Math.abs(c);
    }
  };
  wrap = function(text, width) {
    return text.each(function() {
      var dy, line, lineHeight, lineNumber, results, tspan, word, words, y;
      text = d3.select(this);
      words = text.text().split(/\s+/).reverse();
      line = [];
      lineNumber = 0;
      lineHeight = 1.1;
      y = text.attr('y');
      dy = parseFloat(text.attr('dy'));
      tspan = text.text(null).append('tspan').attr({
        x: 0,
        y: y,
        dy: dy + 'em'
      });
      results = [];
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(' '));
        if (tspan.node().getComputedTextLength() > width) {
          line.pop();
          tspan.text(line.join(' '));
          line = [word];
          results.push(tspan = text.append('tspan').attr({
            x: 0,
            y: y,
            dy: ++lineNumber * lineHeight + dy + 'em'
          }).text(word));
        } else {
          results.push(void 0);
        }
      }
      return results;
    });
  };
  return bar = {
    draw: draw
  };
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFBTCxDQUFVLEdBQVYsQ0FBWDtVQUNBLElBQUEsR0FBTyxDQUFFLElBQUY7dUJBQ1AsS0FBQSxHQUFRLElBQUksQ0FBQyxNQUFMLENBQVksT0FBWixDQUNOLENBQUMsSUFESyxDQUVKO1lBQUEsQ0FBQSxFQUFHLENBQUg7WUFDQSxDQUFBLEVBQUcsQ0FESDtZQUVBLEVBQUEsRUFBSSxFQUFFLFVBQUYsR0FBZSxVQUFmLEdBQTRCLEVBQTVCLEdBQWlDLElBRnJDO1dBRkksQ0FNTixDQUFDLElBTkssQ0FNQSxJQU5BLEdBSlY7U0FBQSxNQUFBOytCQUFBOztNQUhGLENBQUE7O0lBaEJRLENBQVY7RUFESztBQWdDUCxTQUFPLEdBQUEsR0FDTDtJQUFBLElBQUEsRUFBTSxJQUFOOztBQS9MNEIsQ0FBaEMiLCJmaWxlIjoiYmFyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiZGVmaW5lIFsnZDMnLCAnZGF0YScsICdncmFwaCddLCAoZDMsIGRhdGEsIGdyYXBoKSAtPlxuICBkcmF3ID0gKG9wdHMpIC0+XG4gICAgaWQgICAgICAgPSBvcHRzLmlkXG4gICAgYWN0aW9uICAgPSBvcHRzLmFjdGlvblxuICAgIHhfdmFycyAgID0gb3B0cy54X3ZhcnNcbiAgICBwYXJhbSAgICA9IG9wdHMucGFyYW1cblxuICAgIHdpZHRoICAgID0gJChcIiMjeyBpZCB9LWdyYXBoXCIpLndpZHRoKCkgLSA1MFxuICAgIGhlaWdodCAgID0gX2cuYmFzZV9ncmFwaC5oZWlnaHQoKSAtIDIwXG5cbiAgICBzb3VyY2VzICA9IGRhdGFcbiAgICAgIC5wbHVjayAgX2cucXVlcmllc1twYXJhbV0sIHBhcmFtXG4gICAgICAuZmlsdGVyIChzKSAtPiBub3QgZGF0YS5pZ25vcmVkX2Fzc2V0KHMpXG5cbiAgICB4X3ZhcnMgICAgICAgPSB4X3ZhcnMuZmlsdGVyIChlKSAtPiBub3QgZGF0YS5pZ25vcmVkX2Fzc2V0IGVcbiAgICB4X3ZhcnNfbGFiZWwgPSB4X3ZhcnMubWFwIChlKSAtPiBfZy5kZXRhaWxzW2VdIG9yIGVcblxuICAgIHggPSBkMy5zY2FsZS5vcmRpbmFsKClcbiAgICAgIC5kb21haW4geF92YXJzX2xhYmVsXG4gICAgICAucmFuZ2VSb3VuZEJhbmRzIFswLCB3aWR0aF1cblxuICAgIHhBeGlzID0gZDMuc3ZnLmF4aXMoKVxuICAgICAgLnNjYWxlIHhcbiAgICAgIC5vcmllbnQgXCJib3R0b21cIlxuXG4gICAgbSA9IGQzLm1heCBzb3VyY2VzLCAoZCkgLT4gZFsndmFsdWUnXVxuXG4gICAgaGlnaGVzdCA9XG4gICAgICBpZiB4X3ZhcnMubGVuZ3RoIGlzIDFcbiAgICAgICAgX2cubWF4X2RpZmYgLyAxMDBcbiAgICAgIGVsc2VcbiAgICAgICAgZDMubWF4IHNvdXJjZXMsIChkKSAtPiBNYXRoLmFicyhkWyd2YWx1ZSddKVxuXG4gICAgeSA9IGQzLnNjYWxlLmxpbmVhcigpXG4gICAgICAuZG9tYWluIFsoLTEpKmhpZ2hlc3QsIGhpZ2hlc3RdXG4gICAgICAucmFuZ2UgIFtoZWlnaHQsIDBdXG5cbiAgICB5QXhpcyA9IGQzLnN2Zy5heGlzKClcbiAgICAgIC5zY2FsZSB5XG4gICAgICAub3JpZW50IFwibGVmdFwiXG4gICAgICAudGlja0Zvcm1hdCAodikgLT4gZ3JhcGgudGlja19mb3JtYXQodixtKVxuXG5cbiAgICBpZiBhY3Rpb24gaXMgJ2NyZWF0ZSdcbiAgICAgIGdyYXBoLmNsZWFyIGlkXG4gICAgICBjb250YWluZXIgPSBncmFwaC5kcmF3IGlkXG5cblxuICAgIGlmIGFjdGlvbiBpcyAndXBkYXRlJ1xuICAgICAgZDMuc2VsZWN0QWxsIFwiIyN7IGlkIH0gLnllYXItd2F0ZXJtYXJrXCJcbiAgICAgICAgLnJlbW92ZSgpXG5cbiAgICAgIGQzLnNlbGVjdEFsbCBcIiMjeyBpZCB9IC5heGlzXCJcbiAgICAgICAgLnJlbW92ZSgpXG5cbiAgICAgIGQzLnNlbGVjdEFsbCBcIiMjeyBpZCB9IC5iYXItZ3JvdXBcIlxuICAgICAgICAucmVtb3ZlKClcblxuICAgICAgY29udGFpbmVyID0gZDMuc2VsZWN0IFwiZyMjeyBpZCB9XCJcblxuICAgIGNvbnRhaW5lci5hcHBlbmQgJ2cnXG4gICAgICAuYXR0clxuICAgICAgICBjbGFzczogICAgICd4IGF4aXMnXG4gICAgICAgIHRyYW5zZm9ybTogXCJ0cmFuc2xhdGUoMCwgI3sgaGVpZ2h0IC8gMiB9KVwiXG5cbiAgICAgIC5jYWxsIHhBeGlzXG5cbiAgICBjb250YWluZXIuc2VsZWN0QWxsKFwiLnRpY2sgdGV4dFwiKVxuICAgICAgLmNhbGwgd3JhcCwgeC5yYW5nZUJhbmQoKVxuXG4gICAgY29udGFpbmVyLmFwcGVuZCAnZydcbiAgICAgIC5hdHRyXG4gICAgICAgIGNsYXNzOiAgJ3kgYXhpcydcblxuICAgICAgLmNhbGwgeUF4aXNcblxuICAgICMgeSBheGlzIG5hbWVcbiAgICBjb250YWluZXIuYXBwZW5kICd0ZXh0J1xuICAgICAgLmF0dHJcbiAgICAgICAgY2xhc3M6ICdheGlzJ1xuICAgICAgICB4OiAtKGhlaWdodC8yKVxuICAgICAgICB5OiAtNTBcbiAgICAgICAgdHJhbnNmb3JtOiAncm90YXRlKC05MCknXG4gICAgICAgIGR5OiAnMWVtJ1xuICAgICAgICAndGV4dC1hbmNob3InOiAnbWlkZGxlJ1xuXG4gICAgICAudGV4dCAoZCkgLT4gXCJjaGFuZ2UgaW4gaW5kaWNhdG9yIG92ZXIgYmFzZSAlXCJcblxuXG4gICAgIyB4IGF4aXMgbmFtZVxuICAgIGNvbnRhaW5lci5hcHBlbmQgJ3RleHQnXG4gICAgICAuYXR0clxuICAgICAgICBjbGFzczogJ2F4aXMnXG4gICAgICAgIHg6IHdpZHRoLzJcbiAgICAgICAgeTogaGVpZ2h0XG4gICAgICAgIGR5OiAnMWVtJ1xuICAgICAgICAndGV4dC1hbmNob3InOiAnbWlkZGxlJ1xuXG4gICAgICAudGV4dCAoZCkgLT4gX2cuc3VidGl0bGVzW3BhcmFtXVxuXG4gICAgYmFyID0gY29udGFpbmVyLnNlbGVjdEFsbCAnLmJhci1ncm91cCdcbiAgICAgIC5kYXRhIHNvdXJjZXNcbiAgICAgIC5lbnRlcigpXG4gICAgICAuYXBwZW5kICdnJ1xuICAgICAgLmF0dHJcbiAgICAgICAgY2xhc3M6ICdiYXItZ3JvdXAnXG5cbiAgICBiYXIuYXBwZW5kICdyZWN0J1xuICAgICAgLmF0dHJcbiAgICAgICAgaWQ6IChkKSAtPiBkW3BhcmFtXVxuICAgICAgICBjbGFzczogICdiYXInXG5cbiAgICAgICAgd2lkdGg6XG4gICAgICAgICAgaWYgeF92YXJzLmxlbmd0aCBpcyAxXG4gICAgICAgICAgICB3aWR0aCAqIDAuNVxuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICh3aWR0aCAvIHhfdmFycy5sZW5ndGgpIC0gNVxuXG4gICAgICAgIGhlaWdodDogKGQpIC0+IE1hdGguYWJzIGZhY3RvcmlzZSBkWyd2YWx1ZSddLCBoaWdoZXN0LCBoZWlnaHQgLyAyXG5cbiAgICAgICAgeDogKGQpIC0+XG4gICAgICAgICAgaWYgcGFyYW0/IGFuZCBkW3BhcmFtXVxuICAgICAgICAgICAgeChfZy5kZXRhaWxzW2RbcGFyYW1dXSkgKyA1XG4gICAgICAgICAgZWxzZVxuICAgICAgICAgICAgd2lkdGggKiAwLjI1XG5cbiAgICAgICAgeTogKGQpIC0+IHBpY2tfeSBkLCBoaWdoZXN0LCBoZWlnaHQgLyAyXG5cbiAgICAgICAgZmlsbDogKGQpIC0+XG4gICAgICAgICAgaWYgZFtwYXJhbV0gaW4gX2cuY3VycmVudF9hc3NldHMgdGhlbiBfZy5ibHVlIGVsc2UgX2cuZ3JleVxuXG4gICAgICAgIFwiZmlsbC1vcGFjaXR5XCI6IDAuNVxuXG4gICAgICAgIHN0cm9rZTogKGQpIC0+XG4gICAgICAgICAgaWYgZFtwYXJhbV0gaW4gX2cuY3VycmVudF9hc3NldHMgdGhlbiBfZy5ibHVlIGVsc2UgX2cuZ3JleVxuXG4gICAgICAgIFwic3Ryb2tlLW9wYWNpdHlcIjogMC4zXG5cbiAgICAgIC5vblxuICAgICAgICAnY2xpY2snOiAoZCkgLT4gX2cuY2xpY2tfZm9jdXMgZCwgaWQsIHBhcmFtXG5cbiAgICAgIGQzLnNlbGVjdEFsbCgndGV4dCcpLm1vdmVUb0Zyb250KCk7XG5cbiAgICAjIGJhci5hcHBlbmQgJ3RleHQnXG4gICAgIyAgIC50ZXh0IChkLGkpIC0+IGRbJ3ZhbHVlJ11cbiAgICAjICAgLmF0dHJcbiAgICAjICAgICB5OiAoZCkgLT4gcGlja195KGQsIGhpZ2hlc3QsIGhlaWdodCAvIDIpICsgMTBcblxuICBmYWN0b3Jpc2UgPSAodmFsdWUsIGhpZ2hlc3RfdmFsdWUsIGhlaWdodCkgLT5cbiAgICByZXR1cm4gMCBpZiBoaWdoZXN0X3ZhbHVlIGlzIDBcblxuICAgIHZhbHVlICogKGhlaWdodCAvIGhpZ2hlc3RfdmFsdWUpXG5cbiAgcGlja195ID0gKGQsIGhpZ2hlc3RfdmFsdWUsIGhlaWdodCkgLT5cbiAgICBjID0gZmFjdG9yaXNlKGRbJ3ZhbHVlJ10sIGhpZ2hlc3RfdmFsdWUsIGhlaWdodClcblxuICAgIHJldHVybiBpZiBjIDwgMCB0aGVuIGhlaWdodCBlbHNlIGhlaWdodCAtIE1hdGguYWJzKGMpXG5cbiAgd3JhcCA9ICh0ZXh0LCB3aWR0aCkgLT5cbiAgICB0ZXh0LmVhY2ggLT5cbiAgICAgIHRleHQgPSBkMy5zZWxlY3QodGhpcylcbiAgICAgIHdvcmRzID0gdGV4dC50ZXh0KCkuc3BsaXQoL1xccysvKS5yZXZlcnNlKClcblxuICAgICAgbGluZSA9IFtdXG4gICAgICBsaW5lTnVtYmVyID0gMFxuICAgICAgbGluZUhlaWdodCA9IDEuMVxuXG4gICAgICB5ID0gdGV4dC5hdHRyICd5J1xuICAgICAgZHkgPSBwYXJzZUZsb2F0IHRleHQuYXR0cignZHknKVxuXG4gICAgICB0c3BhbiA9IHRleHQudGV4dChudWxsKS5hcHBlbmQoJ3RzcGFuJykuYXR0clxuICAgICAgICB4OiAwXG4gICAgICAgIHk6IHlcbiAgICAgICAgZHk6IGR5ICsgJ2VtJ1xuXG4gICAgICB3aGlsZSB3b3JkID0gd29yZHMucG9wKClcbiAgICAgICAgbGluZS5wdXNoIHdvcmRcbiAgICAgICAgdHNwYW4udGV4dCBsaW5lLmpvaW4oJyAnKVxuICAgICAgICBpZiB0c3Bhbi5ub2RlKCkuZ2V0Q29tcHV0ZWRUZXh0TGVuZ3RoKCkgPiB3aWR0aFxuICAgICAgICAgIGxpbmUucG9wKClcbiAgICAgICAgICB0c3Bhbi50ZXh0IGxpbmUuam9pbignICcpXG4gICAgICAgICAgbGluZSA9IFsgd29yZCBdXG4gICAgICAgICAgdHNwYW4gPSB0ZXh0LmFwcGVuZCgndHNwYW4nKVxuICAgICAgICAgICAgLmF0dHJcbiAgICAgICAgICAgICAgeDogMFxuICAgICAgICAgICAgICB5OiB5XG4gICAgICAgICAgICAgIGR5OiArK2xpbmVOdW1iZXIgKiBsaW5lSGVpZ2h0ICsgZHkgKyAnZW0nXG5cbiAgICAgICAgICAgIC50ZXh0KHdvcmQpXG5cbiAgcmV0dXJuIGJhciA9XG4gICAgZHJhdzogZHJhd1xuIl19
