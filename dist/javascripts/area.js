var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

define(['d3', 'graph', 'global'], function(d3, graph, _g) {
  var area, bisectDate, container, create_time_mark, draw, height, make_frame, move_time_mark, width, x, y;
  container = null;
  width = _g.base_graph.width();
  height = _g.base_graph.height() - 20;
  bisectDate = d3.bisector(function(d) {
    return d.date;
  }).left;
  x = y = null;
  make_frame = function(source0, source1) {
    var frame, i, tmp_diff, y_max, y_min;
    y_min = d3.min(Array.prototype.concat(d3.min(source0, function(d) {
      return d['value'];
    }), d3.min(source1, function(d) {
      return d['value'];
    })));
    y_max = d3.max(Array.prototype.concat(d3.max(source0, function(d) {
      return d['value'];
    }), d3.max(source1, function(d) {
      return d['value'];
    })));
    _g.max_diff = i = 0;
    while (i < source0.length) {
      tmp_diff = Math.abs(source1[i]['value'] - source0[i]['value']) / source0[i]['value'];
      if (tmp_diff > _g.max_diff) {
        _g.max_diff = tmp_diff;
      }
      i++;
    }
    frame = graph.create_frame(source0, {
      min: y_min,
      max: y_max
    }, {
      width: width,
      height: height
    });
    x = frame.x;
    y = frame.y;
    container = graph.draw('area');
    return graph.set_axis(container, frame.xAxis, 0, frame.yAxis, height);
  };
  move_time_mark = function(d, dz) {
    var ddate, tm;
    ddate = d.date || (new Date(_g.current_year + "/01/01"));
    tm = d3.selectAll('.time-marker');
    tm.attr({
      transform: "translate(" + (x(ddate)) + ", 0)"
    });
    return tm.select("text").text(d3.format(",.2f")(dz)).attr({
      y: 20,
      x: -50,
      stroke: 'grey',
      'font-size': '0.8em'
    });
  };
  create_time_mark = function(source, rows) {
    var click, mousemove, tm;
    tm = d3.select('#area').append('g').attr({
      id: "time-marker-line",
      "class": "time-marker"
    });
    tm.append("rect").attr({
      width: 0.1,
      height: height,
      stroke: _g.blue_d,
      fill: "none"
    });
    tm.append("text").attr("x", 0).attr("dy", "-0.35em");
    mousemove = function(it) {
      var b, d, d_left, d_right, i, v, x_mouse;
      if (_g.mousemove_disabled) {
        return;
      }
      x_mouse = x.invert(d3.mouse(it)[0]);
      i = bisectDate(source[0], x_mouse, 1);
      d_left = source[0][i - 1];
      d_right = source[0][i];
      d = (d_right != null) && (x_mouse - d_left.date) > (d_right.date - x_mouse) ? d_right : d_left;
      if (_g.current_year !== d.date.getFullYear()) {
        _g.current_year = d.date.getFullYear();
        _g.reload_graphs('update');
        d3.selectAll('.axis').moveToFront();
        d3.selectAll('.time-marker').attr('year', d.date.getFullYear());
      }
      v = source[0].find(function(e) {
        return e.date.getFullYear() === _g.current_year;
      });
      b = source[1].find(function(e) {
        return e.date.getFullYear() === _g.current_year;
      });
      return area.move_time_mark(d, ((v['value'] - b['value']) / b['value']) * 100);
    };
    click = function(it) {
      _g.mousemove_disabled = !_g.mousemove_disabled;
      mousemove(it);
      return d3.selectAll('.time-marker rect').style({
        stroke: _g.mousemove_disabled ? "black" : _g.blue_d
      });
    };
    return container.append("rect").attr({
      "class": "overlay",
      width: width,
      height: height,
      fill: 'none'
    }).on('mousemove', function() {
      return mousemove(this);
    }).on('click', function() {
      return click(this);
    });
  };
  draw = function(query) {
    var area, b, o;
    graph.clear('area');
    make_frame(query[0], query[1]);
    b = query[1];
    o = query[0];
    area = d3.svg.area().x(function(d) {
      return x(d.date);
    }).y(function(d, i) {
      return y(b[i]['value']);
    });
    container.datum(o);
    container.append('clipPath').attr("id", "clip-below").append("path").attr("d", area.y0(height));
    container.append('clipPath').attr("id", "clip-above").append("path").attr("d", area.y0(0));
    container.append('path').attr({
      d: area.y0(function(d, i) {
        return y(o[i]['value']);
      }),
      fill: function(d) {
        var ref;
        if (ref = d[0]['indicator'], indexOf.call(_g.inverted_indicators, ref) >= 0) {
          return _g.blue;
        } else {
          return _g.blue;
        }
      },
      'fill-opacity': 0.4,
      'clip-path': 'url(#clip-above)'
    });
    container.append('path').attr({
      d: area.y0(function(d, i) {
        return y(o[i]['value']);
      }),
      fill: function(d) {
        var ref;
        if (ref = d[0]['indicator'], indexOf.call(_g.inverted_indicators, ref) >= 0) {
          return _g.blue;
        } else {
          return _g.blue;
        }
      },
      'fill-opacity': 0.4,
      'clip-path': 'url(#clip-below)'
    });
    container.selectAll('path').attr({
      stroke: 'black',
      'stoke-width': 1,
      'stroke-opacity': 0.2
    });
    create_time_mark(query, _g.indicators_query);
    return container.append('text').attr({
      "class": 'axis',
      x: -height / 2,
      y: -50,
      transform: 'rotate(-90)',
      dy: '1em',
      'text-anchor': 'middle'
    }).text(function(d) {
      return _g.details[d[0]['indicator']];
    });
  };
  return area = {
    draw: draw,
    x: function(value) {
      return x.call(this, value);
    },
    create_time_mark: create_time_mark,
    move_time_mark: move_time_mark
  };
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LGdCQUFBLEVBQWtCLGdCQUZsQjtJQUdBLGNBQUEsRUFBZ0IsY0FIaEI7O0FBL0s4QixDQUFsQyIsImZpbGUiOiJhcmVhLmpzIiwic291cmNlc0NvbnRlbnQiOlsiZGVmaW5lIFsnZDMnLCAnZ3JhcGgnLCAnZ2xvYmFsJ10sIChkMywgZ3JhcGgsIF9nKSAtPlxuICBjb250YWluZXIgPSBudWxsXG5cbiAgd2lkdGggID0gX2cuYmFzZV9ncmFwaC53aWR0aCgpXG4gIGhlaWdodCA9IF9nLmJhc2VfZ3JhcGguaGVpZ2h0KCkgLSAyMFxuXG4gIGJpc2VjdERhdGUgPSBkMy5iaXNlY3RvcigoZCkgLT4gZC5kYXRlKS5sZWZ0XG5cbiAgeCA9IHkgPSBudWxsXG5cbiAgbWFrZV9mcmFtZSA9IChzb3VyY2UwLCBzb3VyY2UxKSAtPlxuICAgIHlfbWluID0gZDMubWluIEFycmF5Ojpjb25jYXQoZDMubWluKHNvdXJjZTAsIChkKSAtPiBkWyd2YWx1ZSddKSwgZDMubWluKHNvdXJjZTEsIChkKSAtPiBkWyd2YWx1ZSddKSlcbiAgICB5X21heCA9IGQzLm1heCBBcnJheTo6Y29uY2F0KGQzLm1heChzb3VyY2UwLCAoZCkgLT4gZFsndmFsdWUnXSksIGQzLm1heChzb3VyY2UxLCAoZCkgLT4gZFsndmFsdWUnXSkpXG5cbiAgICBfZy5tYXhfZGlmZiA9IGkgPSAwXG5cbiAgICB3aGlsZSBpIDwgc291cmNlMC5sZW5ndGhcbiAgICAgIHRtcF9kaWZmID0gTWF0aC5hYnMoc291cmNlMVtpXVsndmFsdWUnXSAtIHNvdXJjZTBbaV1bJ3ZhbHVlJ10pIC8gc291cmNlMFtpXVsndmFsdWUnXVxuXG4gICAgICBfZy5tYXhfZGlmZiA9IHRtcF9kaWZmIGlmICh0bXBfZGlmZiA+IF9nLm1heF9kaWZmKVxuXG4gICAgICBpKytcblxuICAgIGZyYW1lID0gZ3JhcGguY3JlYXRlX2ZyYW1lIHNvdXJjZTAsIHsgbWluOiB5X21pbiwgbWF4OiB5X21heCB9LCB7IHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfVxuXG4gICAgeCA9IGZyYW1lLnhcbiAgICB5ID0gZnJhbWUueVxuXG4gICAgY29udGFpbmVyID0gZ3JhcGguZHJhdyAnYXJlYSdcblxuICAgIGdyYXBoLnNldF9heGlzIGNvbnRhaW5lciwgZnJhbWUueEF4aXMsIDAsIGZyYW1lLnlBeGlzLCBoZWlnaHRcblxuICBtb3ZlX3RpbWVfbWFyayA9IChkLCBkeikgLT5cbiAgICBkZGF0ZSA9IGQuZGF0ZSBvciAobmV3IERhdGUoXCIjeyBfZy5jdXJyZW50X3llYXIgfS8wMS8wMVwiKSlcblxuICAgIHRtID0gZDMuc2VsZWN0QWxsICcudGltZS1tYXJrZXInXG5cbiAgICB0bS5hdHRyXG4gICAgICB0cmFuc2Zvcm06IFwidHJhbnNsYXRlKCN7IHgoZGRhdGUpIH0sIDApXCJcblxuICAgIHRtLnNlbGVjdCBcInRleHRcIlxuICAgICAgLnRleHQgZDMuZm9ybWF0KFwiLC4yZlwiKShkeilcbiAgICAgIC5hdHRyXG4gICAgICAgIHk6IDIwXG4gICAgICAgIHg6IC01MFxuICAgICAgICBzdHJva2U6ICdncmV5J1xuICAgICAgICAnZm9udC1zaXplJzogJzAuOGVtJ1xuXG4gIGNyZWF0ZV90aW1lX21hcmsgPSAoc291cmNlLCByb3dzKSAtPlxuICAgIHRtID0gZDMuc2VsZWN0ICcjYXJlYSdcbiAgICAgIC5hcHBlbmQgJ2cnXG4gICAgICAuYXR0clxuICAgICAgICBpZCA6IFwidGltZS1tYXJrZXItbGluZVwiXG4gICAgICAgIGNsYXNzIDogXCJ0aW1lLW1hcmtlclwiXG5cbiAgICB0bS5hcHBlbmQgXCJyZWN0XCJcbiAgICAgIC5hdHRyXG4gICAgICAgIHdpZHRoOiAgMC4xXG4gICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgIHN0cm9rZTogX2cuYmx1ZV9kXG4gICAgICAgIGZpbGw6ICAgXCJub25lXCJcblxuICAgIHRtLmFwcGVuZCBcInRleHRcIlxuICAgICAgLmF0dHIgXCJ4XCIsIDBcbiAgICAgIC5hdHRyIFwiZHlcIiwgXCItMC4zNWVtXCJcblxuXG4gICAgbW91c2Vtb3ZlID0gKGl0KSAtPlxuICAgICAgcmV0dXJuIGlmIF9nLm1vdXNlbW92ZV9kaXNhYmxlZFxuXG4gICAgICB4X21vdXNlID0geC5pbnZlcnQgZDMubW91c2UoaXQpWzBdXG4gICAgICBpID0gYmlzZWN0RGF0ZSBzb3VyY2VbMF0sIHhfbW91c2UsIDFcblxuICAgICAgZF9sZWZ0ICA9IHNvdXJjZVswXVtpLTFdXG4gICAgICBkX3JpZ2h0ID0gc291cmNlWzBdW2ldXG5cbiAgICAgIGQgID0gaWYgZF9yaWdodD8gYW5kICh4X21vdXNlIC0gZF9sZWZ0LmRhdGUpID4gKGRfcmlnaHQuZGF0ZSAtIHhfbW91c2UpIHRoZW4gZF9yaWdodCBlbHNlIGRfbGVmdFxuXG4gICAgICBpZiBfZy5jdXJyZW50X3llYXIgaXNudCBkLmRhdGUuZ2V0RnVsbFllYXIoKVxuICAgICAgICBfZy5jdXJyZW50X3llYXIgPSBkLmRhdGUuZ2V0RnVsbFllYXIoKVxuXG4gICAgICAgIF9nLnJlbG9hZF9ncmFwaHMgJ3VwZGF0ZSdcblxuICAgICAgICBkMy5zZWxlY3RBbGwoJy5heGlzJykubW92ZVRvRnJvbnQoKVxuXG4gICAgICAgIGQzLnNlbGVjdEFsbCAnLnRpbWUtbWFya2VyJ1xuICAgICAgICAgIC5hdHRyICd5ZWFyJywgZC5kYXRlLmdldEZ1bGxZZWFyKClcblxuXG4gICAgICB2ID0gc291cmNlWzBdLmZpbmQgKGUpIC0+XG4gICAgICAgIGUuZGF0ZS5nZXRGdWxsWWVhcigpIGlzIF9nLmN1cnJlbnRfeWVhclxuXG4gICAgICBiID0gc291cmNlWzFdLmZpbmQgKGUpIC0+XG4gICAgICAgIGUuZGF0ZS5nZXRGdWxsWWVhcigpIGlzIF9nLmN1cnJlbnRfeWVhclxuXG4gICAgICBhcmVhLm1vdmVfdGltZV9tYXJrIGQsICgodlsndmFsdWUnXSAtIGJbJ3ZhbHVlJ10pIC8gKGJbJ3ZhbHVlJ10pKSAqIDEwMFxuXG5cbiAgICBjbGljayA9IChpdCkgLT5cbiAgICAgIF9nLm1vdXNlbW92ZV9kaXNhYmxlZCA9IG5vdCBfZy5tb3VzZW1vdmVfZGlzYWJsZWRcblxuICAgICAgbW91c2Vtb3ZlIGl0XG5cbiAgICAgIGQzLnNlbGVjdEFsbCAnLnRpbWUtbWFya2VyIHJlY3QnXG4gICAgICAgIC5zdHlsZSBzdHJva2U6IGlmIF9nLm1vdXNlbW92ZV9kaXNhYmxlZCB0aGVuIFwiYmxhY2tcIiBlbHNlIF9nLmJsdWVfZFxuXG4gICAgY29udGFpbmVyLmFwcGVuZCBcInJlY3RcIlxuICAgICAgLmF0dHJcbiAgICAgICAgY2xhc3M6ICBcIm92ZXJsYXlcIlxuICAgICAgICB3aWR0aDogIHdpZHRoXG4gICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgIGZpbGw6ICAgJ25vbmUnXG5cbiAgICAgIC5vbiAnbW91c2Vtb3ZlJywgLT4gbW91c2Vtb3ZlIHRoaXNcbiAgICAgIC5vbiAnY2xpY2snLCAgICAgLT4gY2xpY2sgdGhpc1xuXG4gIGRyYXcgPSAocXVlcnkpIC0+XG4gICAgZ3JhcGguY2xlYXIgJ2FyZWEnXG5cbiAgICBtYWtlX2ZyYW1lIHF1ZXJ5WzBdLCBxdWVyeVsxXVxuXG4gICAgYiA9IHF1ZXJ5WzFdXG4gICAgbyA9IHF1ZXJ5WzBdXG5cbiAgICBhcmVhID0gZDMuc3ZnLmFyZWEoKVxuICAgICAgLnggKGQpICAgLT4geChkLmRhdGUpXG4gICAgICAueSAoZCxpKSAtPiB5KGJbaV1bJ3ZhbHVlJ10pXG5cbiAgICBjb250YWluZXJcbiAgICAgIC5kYXR1bSBvXG5cbiAgICBjb250YWluZXIuYXBwZW5kICdjbGlwUGF0aCdcbiAgICAgIC5hdHRyIFwiaWRcIiwgXCJjbGlwLWJlbG93XCJcbiAgICAgIC5hcHBlbmQgXCJwYXRoXCJcbiAgICAgIC5hdHRyIFwiZFwiLCBhcmVhLnkwKGhlaWdodClcblxuICAgIGNvbnRhaW5lci5hcHBlbmQgJ2NsaXBQYXRoJ1xuICAgICAgLmF0dHIgXCJpZFwiLCBcImNsaXAtYWJvdmVcIlxuICAgICAgLmFwcGVuZCBcInBhdGhcIlxuICAgICAgLmF0dHIgXCJkXCIsIGFyZWEueTAoMClcblxuICAgIGNvbnRhaW5lci5hcHBlbmQgJ3BhdGgnXG4gICAgICAuYXR0clxuICAgICAgICBkOiBhcmVhLnkwKChkLGkpIC0+IHkob1tpXVsndmFsdWUnXSkpXG4gICAgICAgIGZpbGw6IChkKSAtPiBpZiBkWzBdWydpbmRpY2F0b3InXSBpbiBfZy5pbnZlcnRlZF9pbmRpY2F0b3JzIHRoZW4gX2cuYmx1ZSBlbHNlIF9nLmJsdWVcbiAgICAgICAgJ2ZpbGwtb3BhY2l0eSc6IDAuNFxuICAgICAgICAnY2xpcC1wYXRoJzogJ3VybCgjY2xpcC1hYm92ZSknXG5cbiAgICBjb250YWluZXIuYXBwZW5kICdwYXRoJ1xuICAgICAgLmF0dHJcbiAgICAgICAgZDogYXJlYS55MCgoZCxpKSAtPiB5KG9baV1bJ3ZhbHVlJ10pKVxuICAgICAgICBmaWxsOiAgKGQpIC0+IGlmIGRbMF1bJ2luZGljYXRvciddIGluIF9nLmludmVydGVkX2luZGljYXRvcnMgdGhlbiBfZy5ibHVlIGVsc2UgX2cuYmx1ZVxuICAgICAgICAnZmlsbC1vcGFjaXR5JzogMC40XG4gICAgICAgICdjbGlwLXBhdGgnOiAndXJsKCNjbGlwLWJlbG93KSdcblxuICAgIGNvbnRhaW5lci5zZWxlY3RBbGwgJ3BhdGgnXG4gICAgICAuYXR0clxuICAgICAgICBzdHJva2U6ICdibGFjaydcbiAgICAgICAgJ3N0b2tlLXdpZHRoJzogMVxuICAgICAgICAnc3Ryb2tlLW9wYWNpdHknOiAwLjJcblxuICAgIGNyZWF0ZV90aW1lX21hcmsgcXVlcnksIF9nLmluZGljYXRvcnNfcXVlcnlcblxuICAgIGNvbnRhaW5lci5hcHBlbmQgJ3RleHQnXG4gICAgICAuYXR0clxuICAgICAgICBjbGFzczogJ2F4aXMnXG4gICAgICAgIHg6IC1oZWlnaHQvMlxuICAgICAgICB5OiAtNTBcbiAgICAgICAgdHJhbnNmb3JtOiAncm90YXRlKC05MCknXG4gICAgICAgIGR5OiAnMWVtJ1xuICAgICAgICAndGV4dC1hbmNob3InOiAnbWlkZGxlJ1xuXG4gICAgICAudGV4dCAoZCkgLT4gX2cuZGV0YWlsc1tkWzBdWydpbmRpY2F0b3InXV1cblxuICByZXR1cm4gYXJlYSA9XG4gICAgZHJhdzogZHJhd1xuICAgIHg6ICh2YWx1ZSkgLT4geC5jYWxsIHRoaXMsIHZhbHVlXG4gICAgY3JlYXRlX3RpbWVfbWFyazogY3JlYXRlX3RpbWVfbWFya1xuICAgIG1vdmVfdGltZV9tYXJrOiBtb3ZlX3RpbWVfbWFya1xuIl19
